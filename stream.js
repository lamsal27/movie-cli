// const site = 'https://cloudnestra.com/rcp/MDMwZmM0ZjQ0Y2I4YmI1YTIwODBjZDgxMGFmNzU2Yjg6Y1hGc1Z6TXdiVlZ6U1dGT1QzTTRWMUZJUzBOMlVXcERSMkpoVDNoUlR6SkNVVFpVVjJ0UFNXNXJNSEZ5YVdKbVNsWmtlbGhRVDNOM1ZpdFpiVmRpZDBrMVdrMVdSVEl4U0U1WFNWZFlaUzkyUlRaWWVVUjZOSEJKYVUxU015dHNOemRCVEdaR0swODVNV1ZST1hCTlFuQldVMHRKTVRoV2RXdzRSVXhvVGxsNWNrWkxURFZRU205b1IyaEpNMDlTYVRKb05ISmlUR1ZhWVhVd1MycDNOWHBpVDFFcmVHNW1RMHhKWVVzclZWWXlTVU5qVVVwM1RGSkJjMDVsZWtGQ1lYTTFUMU5qU1U4eU1qRnBUalpIUnpkMmJqZE9RVGxhVFRsRmJsQnphbWRpVjNoRVRVOVBTRlZsUW10TVVVUTViekppY3paVWVVVTNSVXgxTkV0aWRFdGlNMDl1Y1RORlNtWnBOSFEwTnpKSk56bEJTV2RvYjNWbVNFUkhkVXRHU1dsUGFtUklPRzgyYTAxU2QwOUlRV2hLTTFsVlRGcGpiRXRqUm1ORU9IWXdlSEJ4TjFoaFpXZ3JSWGR5VlhwMWJFTlJaVzUxUlROdGVtaGxValJDYmpWalRrVm9lRzlTUXpKdkt6QkdPVVpWVmt4TVQwMWlWVVF2VlhaRWNtUkNMM1ZRZVRNeVpYSXliR2xoZVRKdVUwTlBPREpvZG1NeGMyb3ZaMkZ4Vm1WRVNrNTNjVGRNVjNwUmNHMXlObGhwY1VoWGFtOVZRelJHY25VMlVYWmxlRVF2VUc1S2VYZHdWMmszSzJjelEyMXdVRFJVWjBaMWFEUmpPVFEwVm5waU4zcG5abXQ1ZERoTFVHdEVVVlY1UTNWbk56VTRaRTVoT1hvNFJUQk9SMVZrV0dORmRqWTVkVEZtVlVJMFNUUlFWazFSV1ZZMFNrRm1OV1ZTTkRkelRYcDBibWROUjJodlFtTnJaR1pTUnpkWFUwMVhkbk5oZWpSc1VuVjFjWFJZT1RVM01XVjVhak5LU1RFd1FYSndjVEkwTW5WRGRrZERWMWh2Wmk5WWVFOUpTMjVoU1VwNlZVdHhVR0pyVURWdE5IZFdhbkY1U1VndmNGbEViMVoxV2tkVU5HWXdTMDExWjNwck9WWndUMFZQWWl0U2JTdDVhMmhDTlM5SFFYaGpXRmtyYlhKc1JVOTRaVkl4Tm1KQ1FWRk9RMDFWYlZwT1ZIUTRXWGxuVTNSNFZYWjFiSGRxVUdNMldYcHpkRUo0TUhoQ04wZzVkMnhXVG1ZeFZVMW1iWEZoZVhjd1NsWjZjVk5MVGpkbVFTOU1OVlJxTlc0eVMyUm9lWGN2UjFKcU56ZGlPVVpFUmtOMFlXMXNkbXBGUVc5MFRIZFlXbmx6V1hCSGVHNVBkMkZoYjFWcVRGRnFkbVF2UTJsNUwwMTFSMmwwY2xwWVkxSnRZemRaZDBSWE9Dc3lNVWhvVlRsTFlVOXZhMGRsZFRWWlJqRnFTbTVRWjNWU1ZYYzNSRk5YVXpCVWNEY3pVbGRNVkRoRUx6bEVjV2s1UTJkVlltOUZOR0pNVEU5bWQzSTFMMUI2YWxrMk1YSkJkbGh1U1U4MVJXWnRRV2xKUzFObVIxTXJXVkJLWlhCRVIxRk1RbE5uZUhsSlRYQlFka1ZHVDB0bWFGbEZiRTFMTUhjclFtMTNOMnRLYjNjemR5OUtZak52YzFSS1VVMUlaR1prT0ZSTVVYTllWVnBEVURGelRraE5VMjlEU1cxMk1sVlhWRGhtYXpnd00wNUJhVmRVY25OclJUaFdSMGxyUlhjdmFHTXhNelJIY21oUWFtUmpNbWRhY0doUFlqTXZPREJNSzFReWVWQnRRMnRRTDNsYVptbzFjVmswWTJGMGFUTTBNbE50ZWxKcGQyZHNVbUZRZW5kUVZscDROMjFEVUM5dWR6QlRZM1ZCZGtSa1dYUXhXRzAzWjBkVGFYSktURk5pYkhsdGNVRllOMlkxTWtkSlZrcFZVWEppYkZGSmFFNWxVM1ZWVXpWUkt6QmtSSEJKVm5ObFZVTXZRV1kwYjJKR05GRTVZbFIxTUhwbFFUQkJaMDVtWVVwNWFtWjVaVTFuTjNsc2FuaFdMMGxuVkV4dFMxWlhMMm80YUdSNFNGRmtORzU2V0VZeU5EWXlSVTA1YTNodlRrd3llRWRDYlhWb01XcFRkRlUwYm14NGFsRmFORnBKTVV0UVVWRjRiRUpGVkZaWmFqUXZaVUZwY1hWdk4ycFhVRFZRVW5Bd2FrazBWbUp2VTFCeVVtbG5QVDA9';

const fs = require('fs');

const site = fs.readFileSync('input.txt', 'utf8');

const puppeteer = require('puppeteer');
let k;
(async () => {
    const browser = await puppeteer.launch({ headless: true });
    const page = await browser.newPage();

    const m3u8Links = new Set();

    // Monitor all network requests for .m3u8 files
    k=1;
    page.on('request', request => {
        const url = request.url();
        if (url.includes('.m3u8')) {
            if (!m3u8Links.has(url)) {
                console.log('  â†’ ',k,' Link[s] found');
                k++;
                m3u8Links.add(url);
            }
        }
    });

    // Navigate to the target page
    await page.goto(site); // Replace with actual URL

    // Trigger iframe or player if needed
    await page.evaluate(() => {
        if (typeof loadIframe === 'function') {
            loadIframe();
        }
    });

    // Wait for up to 60 seconds or until 3 unique .m3u8 links are found
    const maxWaitTime = 60000;
    const pollInterval = 1000;
    const startTime = Date.now();

    while (m3u8Links.size < 3 && (Date.now() - startTime < maxWaitTime)) {
        await new Promise(resolve => setTimeout(resolve, pollInterval));
    }

    await browser.close();

    const linksArray = [...m3u8Links];

    if (linksArray.length === 0) {
        console.log('  Watch the movie at ',site,'!');
        return;
    }

    // Try to guess the highest quality based on URL (e.g. contains 1080p, 720p, bitrate)
    const sortedLinks = linksArray.sort((a, b) => {
        const extractQuality = url => {
            const qMatch = url.match(/(\d{3,4})p/) || url.match(/(\d+)(k|kbps)/i);
            return qMatch ? parseInt(qMatch[1]) : 0;
        };
        return extractQuality(b) - extractQuality(a);
    });

    const bestQuality = sortedLinks[0];
    fs.writeFileSync('output.txt', bestQuality, 'utf8');
   
})();

